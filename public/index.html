<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Roll for Rocket Boots! - Character Sheet</title>

  <!-- ‚úÖ Global CSS (layout, show&tell sizing, portrait classes, etc.) -->
  <link rel="stylesheet" href="style.css" />

  <!-- IMPORTANT: your theme switcher swaps this href -->
  <link id="theme-stylesheet" href="style-default.css" rel="stylesheet"/>
</head>

<body>
  <!-- Login Screen -->
  <div id="login-screen"
       style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
              background-color:#222; color:white; flex-direction:column;
              justify-content:center; align-items:center; z-index:2000;">
    <h2>Welcome to Roll for Rocket Boots!</h2>

    <input type="email" id="authEmail" placeholder="Email">
    <input type="password" id="authPassword" placeholder="Password">

    <div style="margin-top: 10px;">
      <button onclick="login()">Log In</button>
      <button onclick="signup()">Sign Up</button>
    </div>

    <div id="loginError" style="color:red; margin-top:10px;"></div>
  </div>

  <!-- Session Screen -->
  <div id="session-screen"
       style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
              background-color:#333; color:white; flex-direction:column;
              justify-content:center; align-items:center; z-index:2000;">
    <h2>Select a Game Session</h2>
    <div id="session-list"></div>

    <button onclick="showCreateSessionScreen()">+ Create New Session</button>
    <button onclick="logout()">üö™ Log Out</button>

    <div id="sessionError" style="color:red; margin-top:10px;"></div>
  </div>

  <!-- Create Session Screen -->
  <div id="create-session-screen"
       style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
              background-color:#444; color:white; flex-direction:column;
              justify-content:center; align-items:center; z-index:2000;">
    <h2>Create a New Game Session</h2>
    <input type="text" id="newSessionName" placeholder="Session Name">
    <textarea id="inviteEmails" placeholder="Invite emails (comma-separated)"></textarea>
    <button onclick="createSession()">Create Session</button>

    <!-- ‚úÖ FIX: you didn‚Äôt have cancelCreateSession() anywhere -->
    <button onclick="hide('create-session-screen'); show('session-screen','flex');">Cancel</button>

    <div id="createSessionError" style="color:red; margin-top:10px;"></div>
  </div>

  <div id="userStatus"></div>

  <!-- App Content -->
  <div id="app-content" style="display:none;">

    <div style="position:absolute; top:10px; left:10px; z-index:1000; display:flex; gap:10px;">
      <button id="gm-tools-button" onclick="openGMTools()" style="display:none;">üõ†Ô∏è GM Tools</button>
    </div>

    <!-- Main Container -->
    <div id="main-container">
      <div style="display:flex; gap:10px;">
        <button id="rules-button" onclick="toggleRules()" type="button">üìñ Rules</button>
        <button onclick="returnToSessions()">‚¨ÖÔ∏è Return to Sessions</button>

        <div id="theme-toggle" style="display:flex; justify-content:flex-end; gap:5px; margin-bottom:10px;">
          <button onclick="setTheme('default')">üè†</button>
          <button onclick="setTheme('dark')">üåô</button>
          <button onclick="setTheme('forest')">üå≤</button>
          <button onclick="setTheme('ocean')">üåä</button>
          <button onclick="setTheme('sky')">üåà</button>
          <button onclick="setTheme('lava')">üåã</button>
        </div>
      </div>

      <div class="title-wrapper" style="text-align:center;">
        <h1>Roll for Rocket Boots!</h1>
      </div>

      <!-- Rules Modal -->
      <div class="modal" id="rules-modal">
        <div class="modal-content">
          <span class="close" onclick="toggleRules()">√ó</span>

          <div class="rules-body">
            <h2>Roll for Rocket Boots ‚Äì Core Rules</h2>

            <h3>1) The Core Loop</h3>
            <p>When a player does something risky or uncertain, the GM calls for a Skill Check:</p>
            <ol>
              <li>Pick the most relevant skill.</li>
              <li>Roll the dice for that skill level.</li>
              <li>Add up the total.</li>
              <li>If the total meets or beats the GM‚Äôs Difficulty, you succeed. Otherwise, you fail.</li>
            </ol>

            <h3>2) Skills</h3>
            <table class="rules-table">
              <thead>
                <tr>
                  <th>Skill Level</th>
                  <th>Dice Rolled</th>
                </tr>
              </thead>
              <tbody>
                <tr><td>Level 1</td><td>2d6</td></tr>
                <tr><td>Level 2</td><td>3d6</td></tr>
                <tr><td>Level 3</td><td>4d6</td></tr>
                <tr><td>Level 4</td><td>5d6</td></tr>
              </tbody>
            </table>

            <h4>Starting Skill</h4>
            <ul>
              <li>Everyone starts with <strong>Do Anything 1</strong>.</li>
              <li><strong>Do Anything</strong> can never level up.</li>
            </ul>

            <h4>Gaining New Skills</h4>
            <ul>
              <li>If you succeed using <strong>Do Anything</strong>, you gain a new skill based on what you did (named however you and the GM like).</li>
              <li>Using the right specific skill usually means the GM sets a lower Difficulty than doing it with <strong>Do Anything</strong>.</li>
            </ul>

            <h3>3) Difficulty Scale (GM)</h3>
            <p>The GM sets a target number based on how hard the action is:</p>
            <table class="rules-table">
              <tbody>
                <tr><td>1‚Äì4</td><td>Trivial</td></tr>
                <tr><td>5‚Äì7</td><td>Average</td></tr>
                <tr><td>8‚Äì9</td><td>Difficult</td></tr>
                <tr><td>10‚Äì12</td><td>Very Hard</td></tr>
                <tr><td>12‚Äì15</td><td>Very Very Hard</td></tr>
                <tr><td>16‚Äì20</td><td>Extremely Hard</td></tr>
                <tr><td>20‚Äì25</td><td>Mind-Bogglingly Hard</td></tr>
                <tr><td>26‚Äì29</td><td>Starting to push the limits of reality</td></tr>
                <tr><td>30</td><td>Almost impossible; may change reality</td></tr>
              </tbody>
            </table>

            <h3>4) Traits</h3>
            <p>Traits are tags the GM attaches to Skills, Items, and Conditions.</p>

            <h4>How Traits Work</h4>
            <ul>
              <li>Conditions only affect skills that share at least one matching trait.</li>
              <li>Items only affect skills that share at least one matching trait.</li>
              <li>If there is no shared trait, the condition/item does nothing for that roll.</li>
            </ul>

            <h4>GM Creates Traits</h4>
            <ul>
              <li>The GM makes up traits when handing out skills, items, or conditions.</li>
              <li>The GM decides how many traits something gets.</li>
              <li>It is recommended to include at least one general trait and one specific trait.</li>
            </ul>

            <p><strong>Example (Item):</strong> A machete might have: <em>Melee</em> (general), <em>Cutting</em> (semi-specific), <em>Brush-Clearing</em> (very specific).</p>

            <h3>5) Conditions, Items &amp; Situational Modifiers</h3>
            <p>The GM can apply bonuses or penalties through conditions, items, and the situation.</p>

            <h4>Conditions</h4>
            <ul>
              <li>Conditions represent things affecting your character (injury, fear, exhaustion, adrenaline, etc.).</li>
              <li>Conditions should have traits.</li>
              <li>A condition only affects a check if it shares at least one trait with the skill being rolled.</li>
            </ul>

            <h4>Items</h4>
            <ul>
              <li>Items are things your character possesses that can alter a skill check.</li>
              <li>Items should have traits.</li>
              <li>An item only affects a check if it shares at least one trait with the skill being rolled.</li>
              <li><strong>Do Anything</strong> can be attempted with any item, even without matching traits, but the results are uncertain and determined by the GM.</li>
            </ul>

            <h4>Situational Modifiers</h4>
            <ul>
              <li>The GM may apply modifiers based on environment, timing, positioning, preparation, or narrative advantage/disadvantage.</li>
            </ul>

            <h3>6) Aiding Another Player</h3>
            <p>A player can help another player‚Äôs check if it makes sense in the fiction.</p>
            <ul>
              <li>The helper contributes half their skill dice (rounded down) from a relevant skill.</li>
              <li>Add those aiding dice into the main roll.</li>
            </ul>

            <h4>Leveling While Aiding</h4>
            <ul>
              <li>When you are aiding, your dice only contribute to a level-up if all aiding dice come up 6.</li>
              <li>Only the person being aided can level up from that roll.</li>
            </ul>

            <h3>7) XP</h3>
            <h4>Gaining XP</h4>
            <ul>
              <li>Whenever you fail a check, you gain <strong>+1 XP</strong>.</li>
            </ul>

            <h4>Spending XP</h4>
            <ul>
              <li>XP can be spent at any time to level skills, unlock specializations, or buy Luck.</li>
            </ul>

            <h4>XP Costs to Level Skills</h4>
            <p>Level-up cost is based on the number of dice at your current level:</p>
            <ul>
              <li>Level 1 ‚Üí 2: 2 XP</li>
              <li>Level 2 ‚Üí 3: 3 XP</li>
              <li>Level 3 ‚Üí 4: 4 XP</li>
              <li>Level 4 ‚Üí Upgrade/Specialization: 5 XP</li>
            </ul>

            <h3>8) Level 4 Cap ‚Äì Upgrades / Specializations</h3>
            <ul>
              <li>Skills cap at Level 4.</li>
              <li>At Level 4, instead of leveling, you unlock an Upgrade / Specialization of that skill.</li>
              <li>You unlock that upgrade by spending 5 XP or by rolling the level-up trigger (see Luck and blow-ups).</li>
              <li>Upgrades are more specific skills, and the GM should usually give them easier difficulties.</li>
            </ul>

            <h3>9) Luck</h3>
            <p>Luck lets you push rolls beyond what your skill normally allows.</p>

            <h4>Spending Luck</h4>
            <ul>
              <li>Spend 1 Luck to roll +1d6 and add it to your total.</li>
              <li>You can spend Luck whenever you want, including after seeing the roll.</li>
              <li>You can spend as much Luck as you want, as many times as you want, on the same check.</li>
            </ul>

            <h4>Luck and Blow-Ups (Exploding Bonus Dice)</h4>
            <ul>
              <li>If a Luck die comes up 6, it blows up: roll +1 bonus d6.</li>
              <li>If that bonus die is a 6, roll another. Keep going until you roll something other than 6.</li>
              <li>All those bonus dice are added to the total.</li>
            </ul>

            <h4>Luck and Leveling</h4>
            <ul>
              <li>If you roll a 6 on a Luck die, the skill you‚Äôre using levels up (if it‚Äôs not Do Anything).</li>
              <li>Luck dice count toward any all-6s thresholds used for leveling and blow-ups.</li>
            </ul>

            <h4>Refreshing Luck</h4>
            <ul>
              <li>At the start of each session, each player gets 1 Luck.</li>
              <li>You can also buy Luck: 2 XP = 1 Luck.</li>
            </ul>

            <h3>10) Wounds (4 Levels)</h3>
            <p>Wounds are a condition track. The GM decides when you take wounds.</p>
            <ol>
              <li><strong>Superficial</strong> ‚Äì Clears with basic first aid or a night‚Äôs rest.</li>
              <li><strong>Seriously Injured</strong> ‚Äì -3 to all checks. Requires advanced medical care to clear. May cause permanent damage.</li>
              <li><strong>Unconscious / Bleeding Out</strong> ‚Äì You can‚Äôt act. Requires immediate advanced medical attention or you die. Causes permanent damage.</li>
              <li><strong>Death</strong> ‚Äì If you take more wounds after Level 3, you die.</li>
            </ol>
          </div>
        </div>
      </div>

      <!-- Character Panel -->
      <div id="character-panel">
        <form id="char-form">
          <div style="margin-bottom:10px;">
            <button onclick="saveCharacterToFirestore()" type="button">üíæ Save</button>
            <button onclick="loadCharacterFromFirestore()" type="button">üìÇ Load</button>
            <span id="autosave-hint" style="font-size:12px; color:#333; margin-left:10px;">
              Autosave initializes after first save
            </span>

            <div style="margin-top:10px;">
              <div class="section-label">NAME</div>

              <div class="name-row">
                <div class="portrait-wrap">
                 <img
                      id="character-portrait"
                      class="portrait-img"
                      alt="Character portrait"
                      src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw=="
                    />
                  <label class="portrait-upload-btn" title="Upload portrait">
                    üì∑
                    <input id="portrait-upload" type="file" accept="image/*" />
                  </label>
                </div>

                <input id="player-name" autocomplete="off" placeholder="Enter your name" type="text"/>
              </div>
            </div>

            <input accept=".json" id="fileInput" onchange="uploadCharacter(event)" style="display:none;" type="file"/>
          </div>

          <br/><br/>

          <div id="counters-section">
            <div class="counter-block">
              <h2>Exp.</h2>
              <div class="counter">
                <button onclick="adjustExp(-1)" type="button">‚¨á</button>
                <span id="exp-value">0</span>
                <button onclick="adjustExp(1)" type="button">‚¨Ü</button>
              </div>
            </div>

            <div class="counter-block">
              <h2>Luck</h2>
              <div class="counter">
                <button onclick="adjustLuck(-1)" type="button">‚¨á</button>
                <span id="luck-value">1</span>
                <button onclick="adjustLuck(1)" type="button">‚¨Ü</button>
              </div>
            </div>

            <div class="counter-block">
              <div class="wounds-section">
                <h2>Wounds</h2>
                <div class="wounds">
                  <button onclick="toggleWound(0)" type="button"></button>
                  <button onclick="toggleWound(1)" type="button"></button>
                  <button onclick="toggleWound(2)" type="button"></button>
                  <button onclick="toggleWound(3)" type="button"></button>
                </div>
              </div>
            </div>
          </div>

          <br/>

          <h2 class="section-title skills-title">Skills</h2>
          <div id="skills-section">
            <div id="skills-container"></div>
            <div style="margin-top:10px;">
              <button onclick="addSkill()" type="button">+ New Skill</button>
            </div>
          </div>

          <h2 class="section-title">Conditions</h2>
          <div id="conditions-section">
            <div id="conditions-container"></div>
            <div style="margin-top:10px;">
              <button onclick="addCondition()" type="button">+ New Condition</button>
            </div>
          </div>

          <br/>

          <h2 class="section-title">Inventory</h2>
          <div id="items-section">
            <div id="items-container"></div>
            <div style="margin-top:10px;">
              <button onclick="addItem()" type="button">+ Add Item</button>
            </div>
          </div>

          <br/>
          <button onclick="clearData()" type="button">Clear</button>
        </form>
      </div>

      <div id="bottom-buttons" style="margin-top:20px; text-align:center;"></div>
    </div>

    <!-- GM Mode Dash -->
    <div id="gm-mode-panel" style="display:none; padding:10px; flex-grow:1;">
      <h2 style="background: yellow; color: black; padding: 5px;">GM MODE - LIVE CHARACTER VIEW</h2>
      <div id="gm-character-panels" style="display:flex; flex-wrap:wrap; gap:10px;"></div>
    </div>

    <!-- Show & Tell Panel -->
    <div id="show-panel">
      <div id="zoom-container">
        <div id="zoom-content">

          <!-- Tabs -->
          <div id="tab-container" style="width:100%;">
            <div id="tab-bar" style="display:flex; gap:6px; padding-bottom:10px;"></div>
          </div>

          <!-- Drawing Toolbar -->
          <div id="drawing-toolbar" style="display:flex; gap:8px; align-items:center; margin-bottom:10px;">
            <label style="color:white; font-size:12px;">‚úèÔ∏è Width</label>
            <input id="draw-width" type="range" min="1" max="30" value="4" step="1">

            <input id="draw-color" type="color" value="#ff0000" title="Pen color">

            <button id="tool-pen" type="button">‚úèÔ∏è Pen</button>
            <button id="tool-eraser" type="button">üßΩ Eraser</button>

            <button id="clear-mine" type="button">Clear Mine</button>
            <button id="clear-all" type="button" style="display:none;">üßπ GM Clear All</button>
          </div>

          <!-- ‚úÖ Image + canvas viewport -->
          <div id="image-display-area">
            <div id="panzoom-layer">
              <img id="tab-image" src="" alt="" draggable="false">
              <canvas id="draw-canvas"></canvas>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Chat Panel -->
    <div id="chat-panel">
      <div id="chat-controls" style="display:flex; justify-content:space-around; padding:5px; background-color:#111; border-bottom:2px solid #555;">
        <button onclick="toggleCharacterPanel()">Character</button>
        <button onclick="toggleShowAndTell()">Show & Tell</button>
      </div>

      <div id="chat-messages" style="flex:1; overflow-y:auto; padding:10px; word-wrap:break-word; overflow-wrap:break-word; white-space:pre-wrap;"></div>

      <div style="margin-top:5px; display:flex; gap:2px; flex-wrap:wrap;">
        <button style="padding:2px 6px; font-size:12px;" onclick="rollD6(1)">1üé≤</button>
        <button style="padding:2px 6px; font-size:12px;" onclick="rollD6(2)">2üé≤</button>
        <button style="padding:2px 6px; font-size:12px;" onclick="rollD6(3)">3üé≤</button>
        <button style="padding:2px 6px; font-size:12px;" onclick="rollD6(4)">4üé≤</button>
        <button style="padding:2px 6px; font-size:12px;" onclick="rollD6(5)">5üé≤</button>
      </div>

      <div id="chatInput" contenteditable="true" style="border:1px solid gray; padding:5px; height:60px; overflow-y:auto;"></div>
      <button onclick="sendChatMessage()">Send</button>

      <div style="margin-top:10px;">
        <label for="chatColorPicker">Chat Name Color:</label>
        <input type="color" id="chatColorPicker" value="#ffffff" onchange="saveChatColor()" />
      </div>
    </div>
  </div>

  <!-- GM Tools Panel -->
  <div id="gm-tools-panel" style="
    display:none;
    position:fixed;
    top:60px;
    left:10px;
    width:300px;
    height:400px;
    background-color:#222;
    color:white;
    border:2px solid #00e5ff;
    border-radius:8px;
    padding:15px;
    z-index:2000;
    box-shadow:4px 4px #000;
    overflow-y:auto;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3 style="margin:0;">GM Tools</h3>
      <button onclick="toggleGMTools()" style="background:red; color:white;">X</button>
    </div>
    <hr style="margin:10px 0;">
    <button id="gm-mode-toggle" onclick="toggleGMMode()">GM Mode</button>
    <button onclick="openGMImageModal()">GM Gallery</button>
    <button onclick="cleardisplay()">Clear S&T</button>
    <button onclick="clearchat()">Clear Chat</button>
  </div>

  <!-- GM Image Gallery Modal -->
  <div id="gm-image-gallery-modal" class="modal"
       style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
              background-color:rgba(0,0,0,0.8); z-index:3000; justify-content:center; align-items:center;">
    <div style="background:#222; padding:20px; max-width:90%; max-height:90%; overflow:auto; border:2px solid #555; position:relative;">
      <span onclick="closeGMImageModal()" style="position:absolute; top:5px; right:10px; cursor:pointer; font-size:20px; color:white;">‚ùå</span>
      <h2 style="color:white;">gallery</h2>

      <label>
        Folder:
        <input type="text" id="gm-folder-input" placeholder="e.g., Maps or NPCs">
      </label>

      <input type="file" id="gm-image-upload" accept="image/*">
      <span id="gm-upload-filename" style="color:white; margin-left:10px;"></span>
      <button onclick="uploadGMImage()">Upload</button>

      <div id="upload-status" style="margin-top:5px; color:lightgreen;"></div>
      <div id="image-list" style="display:flex; flex-wrap:wrap; gap:10px; margin-top:10px;"></div>
    </div>
  </div>

  <!-- Load Character Modal -->
  <div id="loadCharacterModal"
       style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%);
              background:#222; padding:20px; border:2px solid #555; color:white; z-index:999;">
    <h3>Select a Character</h3>
    <select id="characterSelect" style="margin-bottom:10px; width:100%; padding:5px;"></select>
    <br>
    <button onclick="confirmCharacterLoad()">Load</button>
    <button onclick="promptAndCreateCharacter()">‚ûï Create New Character</button>
    <button onclick="document.getElementById('loadCharacterModal').style.display='none'">Cancel</button>
  </div>

  <!-- Username Modal -->
  <div id="username-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <h3>Create your username</h3>
      <input type="text" id="usernameInput" placeholder="Choose a username" maxlength="20" />
      <button id="saveUsernameBtn">Save Username</button>
      <p id="username-status" style="color: lightgreen; display:none;">‚úÖ Username saved!</p>
      <button id="nextButton" style="display:none;">Next</button>
    </div>
  </div>

  <!-- Firebase SDKs FIRST -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-storage-compat.js"></script>

  <!-- THEN initialize Firebase -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCvjcNDhsFrbsc-U3Osp1Xqb-e9MyGfgEI",
      authDomain: "roll-4-rocket-boots.firebaseapp.com",
      projectId: "roll-4-rocket-boots",
      storageBucket: "roll-4-rocket-boots",
      messagingSenderId: "896629635485",
      appId: "1:896629635485:web:31b85d7aa63531dd3f9774",
      measurementId: "G-5XJ0KR4TP6"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.app().storage("gs://roll-4-rocket-boots");
  </script>

  <!-- ‚úÖ NOW load your logic files AFTER Firebase is ready -->
  <script src="login.js"></script>
  <script src="script.js"></script>
</body>
</html>
