<!DOCTYPE html>
<html>
<head>
  <title>Roll for Rocket Boots! - Character Sheet</title>

  <!-- IMPORTANT: your theme switcher swaps this href -->
  <link id="theme-stylesheet" href="style-default.css" rel="stylesheet"/>

  <style>
    /* Layout */
    #app-content {
      display: flex;
      flex-direction: row;
      height: 100vh;
      overflow: hidden;
    }

    #main-container {
      flex: 1 1 75%;
      max-width: 75%;
      overflow-y: auto;
      padding: 10px;
      padding-top: 60px;
    }

    #chat-panel {
      flex: 0 0 25%;
      max-width: 25%;
      display: none;
      flex-direction: column;
      height: 100vh;
      background-color: #222;
      color: white;
      border-left: 2px solid #555;
      overflow: hidden;
    }

    #chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    /* Make Show & Tell a real â€œscreenâ€ with a real image area */
    #show-panel {
      display: none;
      flex: 1 1 75%;
      max-width: 75%;
      height: 100vh;
      background: #111;
      padding: 20px;
      padding-top: 40px;
      box-sizing: border-box;
    }

    #zoom-container {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #zoom-content {
      display: flex;
      flex-direction: column;
      height: 100%;
      gap: 10px;
      min-height: 0; /* critical for flex children */
    }

    #tab-container { flex: 0 0 auto; }
    #drawing-toolbar { flex: 0 0 auto; }

    /* âœ… The actual viewport area must be sized */
    #image-display-area {
      flex: 1 1 auto;
      min-height: 0;           /* critical for flex children */
      position: relative;
      overflow: hidden;
      border: 1px solid #333;
      border-radius: 8px;
      background: #0b0b0b;
      touch-action: none;      /* prevents touch gestures from stealing events */
    }

    /* Pan/Zoom Layer */
    #panzoom-layer {
      position: absolute;
      top: 0;
      left: 0;
      transform-origin: 0 0;
      will-change: transform;
    }

    /* âœ… Image should NOT capture pointer events (fixes "pan only outside image") */
    #tab-image {
      position: absolute;
      top: 0;
      left: 0;
      user-select: none;
      -webkit-user-drag: none;
      pointer-events: none;
    }

    /* Drawing canvas sits above image */
    #draw-canvas {
      position: absolute;
      top: 0;
      left: 0;
      touch-action: none;
    }
  </style>
</head>

<body>
  <!-- Login Screen -->
  <div id="login-screen"
       style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
              background-color:#222; color:white; display:flex; flex-direction:column;
              justify-content:center; align-items:center; z-index:2000;">
    <h2>Welcome to Roll for Rocket Boots!</h2>

    <input type="email" id="authEmail" placeholder="Email">
    <input type="password" id="authPassword" placeholder="Password">

    <div style="margin-top: 10px;">
      <button onclick="login()">Log In</button>
      <button onclick="signup()">Sign Up</button>
    </div>

    <div id="loginError" style="color:red; margin-top:10px;"></div>
  </div>

  <!-- Session Screen -->
  <div id="session-screen"
       style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
              background-color:#333; color:white; display:flex; flex-direction:column;
              justify-content:center; align-items:center; z-index:2000;">
    <h2>Select a Game Session</h2>
    <div id="session-list"></div>

    <button onclick="showCreateSessionScreen()">+ Create New Session</button>
    <button onclick="logout()">ğŸšª Log Out</button>

    <div id="sessionError" style="color:red; margin-top:10px;"></div>
  </div>

  <!-- Create Session Screen -->
  <div id="create-session-screen"
       style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
              background-color:#444; color:white; display:flex; flex-direction:column;
              justify-content:center; align-items:center; z-index:2000;">
    <h2>Create a New Game Session</h2>
    <input type="text" id="newSessionName" placeholder="Session Name">
    <textarea id="inviteEmails" placeholder="Invite emails (comma-separated)"></textarea>
    <button onclick="createSession()">Create Session</button>

    <!-- âœ… FIX: you didnâ€™t have cancelCreateSession() anywhere -->
    <button onclick="hide('create-session-screen'); show('session-screen','flex');">Cancel</button>

    <div id="createSessionError" style="color:red; margin-top:10px;"></div>
  </div>

  <div id="userStatus"></div>

  <!-- App Content -->
  <div id="app-content" style="display:none;">

    <div style="position:absolute; top:10px; left:10px; z-index:1000; display:flex; gap:10px;">
      <button id="gm-tools-button" onclick="openGMTools()" style="display:none;">ğŸ› ï¸ GM Tools</button>
    </div>

    <!-- Main Container -->
    <div id="main-container">
      <div style="display:flex; gap:10px;">
        <button id="rules-button" onclick="toggleRules()" type="button">ğŸ“– Rules</button>
        <button onclick="returnToSessions()">â¬…ï¸ Return to Sessions</button>

        <div id="theme-toggle" style="display:flex; justify-content:flex-end; gap:5px; margin-bottom:10px;">
          <button onclick="setTheme('default')">ğŸ </button>
          <button onclick="setTheme('dark')">ğŸŒ™</button>
          <button onclick="setTheme('forest')">ğŸŒ²</button>
          <button onclick="setTheme('ocean')">ğŸŒŠ</button>
          <button onclick="setTheme('sky')">ğŸŒˆ</button>
          <button onclick="setTheme('lava')">ğŸŒ‹</button>
        </div>
      </div>

      <div class="title-wrapper" style="text-align:center;">
        <h1>Roll for Rocket Boots!</h1>
      </div>

      <!-- Rules Modal -->
      <div class="modal" id="rules-modal">
        <div class="modal-content">
          <span class="close" onclick="toggleRules()">Ã—</span>
          <img alt="Rule Page 1" src="rules/1.png"/>
          <img alt="Rule Page 2" src="rules/2.png"/>
        </div>
      </div>

      <!-- Character Panel -->
      <div id="character-panel">
        <form id="char-form">
          <div style="margin-bottom:10px;">
            <button onclick="saveCharacterToFirestore()" type="button">ğŸ’¾ Save</button>
            <button onclick="loadCharacterFromFirestore()" type="button">ğŸ“‚ Load</button>
            <span id="autosave-hint" style="font-size:12px; color:#333; margin-left:10px;">Autosave initializes after first save</span>

            <div style="margin-top:10px;">
              <div class="section-label">NAME</div>
              <input id="player-name" autocomplete="off" placeholder="Enter your name" type="text"/>
            </div>

            <input accept=".json" id="fileInput" onchange="uploadCharacter(event)" style="display:none;" type="file"/>
          </div>

          <br/><br/>

          <div id="counters-section">
            <div class="counter-block">
              <h2>Exp.</h2>
              <div class="counter">
                <button onclick="adjustExp(-1)" type="button">â¬‡</button>
                <span id="exp-value">0</span>
                <button onclick="adjustExp(1)" type="button">â¬†</button>
              </div>
            </div>

            <div class="counter-block">
              <h2>Luck</h2>
              <div class="counter">
                <button onclick="adjustLuck(-1)" type="button">â¬‡</button>
                <span id="luck-value">1</span>
                <button onclick="adjustLuck(1)" type="button">â¬†</button>
              </div>
            </div>

            <div class="counter-block">
              <div class="wounds-section">
                <h2>Wounds</h2>
                <div class="wounds">
                  <button onclick="toggleWound(0)" type="button"></button>
                  <button onclick="toggleWound(1)" type="button"></button>
                  <button onclick="toggleWound(2)" type="button"></button>
                  <button onclick="toggleWound(3)" type="button"></button>
                </div>
              </div>
            </div>
          </div>

          <br/>

          <h2 class="section-title skills-title">Skills</h2>
          <div id="skills-section">
            <div id="skills-container"></div>
            <div style="margin-top:10px;">
              <button onclick="addSkill()" type="button">+ New Skill</button>
            </div>
          </div>

          <h2 class="section-title">Conditions</h2>
          <div id="conditions-section">
            <div id="conditions-container"></div>
            <div style="margin-top:10px;">
              <button onclick="addCondition()" type="button">+ New Condition</button>
            </div>
          </div>

          <br/>

          <h2 class="section-title">Inventory</h2>
          <div id="items-section">
            <div id="items-container"></div>
            <div style="margin-top:10px;">
              <button onclick="addItem()" type="button">+ Add Item</button>
            </div>
          </div>

          <br/>
          <button onclick="clearData()" type="button">Clear</button>
        </form>
      </div>

      <div id="bottom-buttons" style="margin-top:20px; text-align:center;"></div>
    </div>

    <!-- GM Mode Dash -->
    <div id="gm-mode-panel" style="display:none; padding:10px; flex-grow:1;">
      <h2 style="background: yellow; color: black; padding: 5px;">GM MODE - LIVE CHARACTER VIEW</h2>
      <div id="gm-character-panels" style="display:flex; flex-wrap:wrap; gap:10px;"></div>
    </div>

    <!-- Show & Tell Panel -->
    <div id="show-panel">
      <div id="zoom-container">
        <div id="zoom-content">

          <!-- Tabs -->
          <div id="tab-container" style="width:100%;">
            <div id="tab-bar" style="display:flex; gap:6px; padding-bottom:10px;"></div>
          </div>

          <!-- Drawing Toolbar -->
          <div id="drawing-toolbar" style="display:flex; gap:8px; align-items:center; margin-bottom:10px;">
            <label style="color:white; font-size:12px;">âœï¸ Width</label>
            <input id="draw-width" type="range" min="1" max="30" value="4" step="1">

            <input id="draw-color" type="color" value="#ff0000" title="Pen color">

            <button id="tool-pen" type="button">âœï¸ Pen</button>
            <button id="tool-eraser" type="button">ğŸ§½ Eraser</button>

            <button id="clear-mine" type="button">Clear Mine</button>
            <button id="clear-all" type="button" style="display:none;">ğŸ§¹ GM Clear All</button>
          </div>

          <!-- âœ… Image + canvas viewport -->
          <div id="image-display-area">
            <div id="panzoom-layer">
              <img id="tab-image" src="" alt="" draggable="false">
              <!-- âœ… IMPORTANT: match the id your script expects -->
              <canvas id="draw-canvas"></canvas>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Chat Panel -->
    <div id="chat-panel">
      <div id="chat-controls" style="display:flex; justify-content:space-around; padding:5px; background-color:#111; border-bottom:2px solid #555;">
        <button onclick="toggleCharacterPanel()">Character</button>
        <button onclick="toggleShowAndTell()">Show & Tell</button>
      </div>

      <div id="chat-messages" style="flex:1; overflow-y:auto; padding:10px; word-wrap:break-word; overflow-wrap:break-word; white-space:pre-wrap;"></div>

      <div style="margin-top:5px; display:flex; gap:2px; flex-wrap:wrap;">
        <button style="padding:2px 6px; font-size:12px;" onclick="rollD6(1)">1ğŸ²</button>
        <button style="padding:2px 6px; font-size:12px;" onclick="rollD6(2)">2ğŸ²</button>
        <button style="padding:2px 6px; font-size:12px;" onclick="rollD6(3)">3ğŸ²</button>
        <button style="padding:2px 6px; font-size:12px;" onclick="rollD6(4)">4ğŸ²</button>
        <button style="padding:2px 6px; font-size:12px;" onclick="rollD6(5)">5ğŸ²</button>
      </div>

      <div id="chatInput" contenteditable="true" style="border:1px solid gray; padding:5px; height:60px; overflow-y:auto;"></div>
      <button onclick="sendChatMessage()">Send</button>

      <div style="margin-top:10px;">
        <label for="chatColorPicker">Chat Name Color:</label>
        <input type="color" id="chatColorPicker" value="#ffffff" onchange="saveChatColor()" />
      </div>
    </div>
  </div>

  <!-- GM Tools Panel -->
  <div id="gm-tools-panel" style="
    display:none;
    position:fixed;
    top:60px;
    left:10px;
    width:300px;
    height:400px;
    background-color:#222;
    color:white;
    border:2px solid #00e5ff;
    border-radius:8px;
    padding:15px;
    z-index:2000;
    box-shadow:4px 4px #000;
    overflow-y:auto;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3 style="margin:0;">GM Tools</h3>
      <button onclick="toggleGMTools()" style="background:red; color:white;">X</button>
    </div>
    <hr style="margin:10px 0;">
    <button id="gm-mode-toggle" onclick="toggleGMMode()">GM Mode</button>
    <button onclick="openGMImageModal()">GM Gallery</button>
    <button onclick="cleardisplay()">Clear S&T</button>
    <button onclick="clearchat()">Clear Chat</button>
  </div>

  <!-- GM Image Gallery Modal -->
  <div id="gm-image-gallery-modal" class="modal"
       style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
              background-color:rgba(0,0,0,0.8); z-index:3000; justify-content:center; align-items:center;">
    <div style="background:#222; padding:20px; max-width:90%; max-height:90%; overflow:auto; border:2px solid #555; position:relative;">
      <span onclick="closeGMImageModal()" style="position:absolute; top:5px; right:10px; cursor:pointer; font-size:20px; color:white;">âŒ</span>
      <h2 style="color:white;">gallery</h2>

      <label>
        Folder:
        <input type="text" id="gm-folder-input" placeholder="e.g., Maps or NPCs">
      </label>

      <input type="file" id="gm-image-upload" accept="image/*">
      <span id="gm-upload-filename" style="color:white; margin-left:10px;"></span>
      <button onclick="uploadGMImage()">Upload</button>

      <div id="upload-status" style="margin-top:5px; color:lightgreen;"></div>
      <div id="image-list" style="display:flex; flex-wrap:wrap; gap:10px; margin-top:10px;"></div>
    </div>
  </div>

  <!-- Load Character Modal -->
  <div id="loadCharacterModal"
       style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%);
              background:#222; padding:20px; border:2px solid #555; color:white; z-index:999;">
    <h3>Select a Character</h3>
    <select id="characterSelect" style="margin-bottom:10px; width:100%; padding:5px;"></select>
    <br>
    <button onclick="confirmCharacterLoad()">Load</button>
    <button onclick="promptAndCreateCharacter()">â• Create New Character</button>
    <button onclick="document.getElementById('loadCharacterModal').style.display='none'">Cancel</button>
  </div>

  <!-- Username Modal -->
  <div id="username-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <h3>Create your username</h3>
      <input type="text" id="usernameInput" placeholder="Choose a username" maxlength="20" />
      <button id="saveUsernameBtn">Save Username</button>
      <p id="username-status" style="color: lightgreen; display:none;">âœ… Username saved!</p>
      <button id="nextButton" style="display:none;">Next</button>
    </div>
  </div>

  <!-- Firebase SDKs FIRST -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-storage-compat.js"></script>

  <!-- THEN initialize Firebase -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCvjcNDhsFrbsc-U3Osp1Xqb-e9MyGfgEI",
      authDomain: "roll-4-rocket-boots.firebaseapp.com",
      projectId: "roll-4-rocket-boots",
      storageBucket: "roll-4-rocket-boots",
      messagingSenderId: "896629635485",
      appId: "1:896629635485:web:31b85d7aa63531dd3f9774",
      measurementId: "G-5XJ0KR4TP6"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.app().storage("gs://roll-4-rocket-boots");
  </script>

  <!-- âœ… NOW load your logic files AFTER Firebase is ready -->
  <script src="login.js"></script>
  <script src="script.js"></script>
</body>
</html>
